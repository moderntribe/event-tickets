var ticketHeaderImage=window.ticketHeaderImage||{};!function(t,e,i){"use strict";var a=e(document.getElementById("tribe-event-datepickers")),r=e(document.getElementById("tribetickets")),n=e(document.getElementById("event_tickets")),c=e(document.getElementById("tribe-tickets-enable-global-stock")),d=e(document.getElementById("tribe-tickets-global-stock-level")),o=!1,s=e("html, body"),l=0,_=e(document.getElementById("tribe_panel_base")),g=e(document.getElementById("tribe_panel_edit")),k=e(document.getElementById("tribe_panel_settings"));ticketHeaderImage={uploader:function(){var t=wp.media({title:HeaderImageData.title,multiple:!1,library:{type:"image"},button:{text:HeaderImageData.button}});return t.on("close",function(){var e=t.state().get("selection").toJSON();e.length&&ticketHeaderImage.render(e[0])}),t.open(),!1},render:function(t){e("#tribe_ticket_header_preview").html(ticketHeaderImage.imgHTML(t)),e("#tribe_ticket_header_image_id").val(t.id),e("#tribe_ticket_header_remove").show()},imgHTML:function(t){var e='<img src="'+t.url+'" ';return e+='width="'+t.width+'" ',e+='height="'+t.height+'" ',e+="/>"}},e(document).ready(function(){function m(){return c.prop("checked")}function p(){o=!0,r.trigger("set-global-stock-fields.tribe")}function u(){e("tr.ticket_advanced").hide(),e("tr.ticket_advanced_"+f()+":not(.sale_price)").show(),r.trigger("set-advanced-fields.tribe"),e(document.getElementById("tribetickets")).trigger("ticket-provider-changed.tribe")}function f(){var t=e('input[name="ticket_provider"]:checked');return t.length>0?t[0].value:""}function h(){var t=r.find("tr.ticket_advanced.history");if(t.length){var e=t.find("a.toggle-history"),i=e.find("span"),a=t.find("ul");t.find("a.toggle-history").click(function(t){return i.toggle(),a.toggle(),t.stopPropagation(),!1})}}function b(t,e){t.preventDefault(),i!==e.attr("aria-hidden")&&"false"!==e.attr("aria-hidden")?(_!==e&&_.attr("aria-hidden","true"),e.attr("aria-hidden","false")):(e.attr("aria-hidden","true"),_!==e&&_.attr("aria-hidden","false"))}r.on({"spin.tribe":function(t,i){("undefined"==typeof i||e.inArray(i,["start","stop"]))&&(i="stop"),"stop"===i?n.css("opacity","1").find("#tribe-loading").hide():n.css("opacity","0.5").find("#tribe-loading").show()},"clear.tribe":function(){var t=e(this),i=t.find("#ticket_form"),a=i.find("tr:not(.event-wide-settings)");a.find('input:not(:button):not(:radio):not(:checkbox):not([type="hidden"]), textarea').val(""),a.find("input:checkbox").attr("checked",!1),a.find("#ticket_id").val(""),t.find('#ticket_form input[name="show_attendee_info"]').prop("checked",!1).change(),t.find("input[data-default-value]").each(function(){var t=e(this);t.val(t.data("default-value"))}),t.find("#ticket_start_date").datepicker("option","maxDate",null),t.find("#ticket_end_date").datepicker("option","minDate",null),t.find(".ticket_start_time, .ticket_end_time, .ticket.sale_price").hide(),t.find("#ticket_price").removeProp("disabled").siblings(".no-update-message").html("").hide().end().siblings(".description").show(),e("#tribe-tickets-attendee-sortables").empty(),e(".tribe-tickets-attendee-saved-fields").show(),i.hide()},"focus.tribe":function(){s.animate({scrollTop:n.offset().top-50},500)},"edit-tickets-complete.tribe":function(){h()},"set-advanced-fields.tribe":function(){var t=e(this),i=t.find("#ticket_form"),a=i.find("tr.ticket_advanced:not(.ticket_advanced_meta)").find("input, select, textarea"),n=i.find(".ticket_provider:checked").val();a.each(function(){var t=e(this);t.attr("name")&&t.data("name",t.attr("name")).attr({name:"",id:""}),t.closest("tr").hasClass("ticket_advanced_"+n)&&t.data("name")&&0===t.attr("name").length&&t.attr({name:t.data("name"),id:t.data("name")})}),r.trigger("set-global-stock-fields.tribe"),e("#ticket_global_stock").change(function(){r.trigger("set-global-stock-fields.tribe")})},"set-global-stock-fields.tribe":function(){var t=f(),i=e(this).find("#ticket_form").find(".ticket_advanced_"+t);if(!(i.length<1)){var a=i.filter(".stock"),r=i.filter(".global-stock-mode"),n=r.filter(".sales-cap-field"),c=e("#ticket_global_stock").val(),o=m();if(d.toggle(o),r.toggle(m()),a.toggle(!o),o)switch(c){case"global":n.hide(),a.hide();break;case"capped":n.show(),a.hide();break;case"own":n.hide(),a.show()}}}}),a.length&&(l=a.data("startofweek"));var v={dateFormat:"yy-mm-dd",showAnim:"fadeIn",changeMonth:!0,changeYear:!0,numberOfMonths:3,firstDay:l,showButtonPanel:!1,onChange:function(){},onSelect:function(t,i){var a=e.datepicker.parseDate("yy-mm-dd",t);"ticket_start_date"===i.id?(e("#ticket_end_date").datepicker("option","minDate",a),a?e(".ticket_start_time").show():e(".ticket_start_time").hide()):(e("#ticket_start_date").datepicker("option","maxDate",a),a?e(".ticket_end_time").show():e(".ticket_end_time").hide())}};e.extend(v,tribe_l10n_datatables.datepicker),e("#ticket_start_date").datepicker(v).keyup(function(t){8!==t.keyCode&&46!==t.keyCode||e.datepicker._clearDate(this)}),e("#ticket_end_date").datepicker(v).keyup(function(t){8!==t.keyCode&&46!==t.keyCode||e.datepicker._clearDate(this)}),c.change(p),c.trigger("change"),o=!1,e("input[name=ticket_provider]:radio").change(function(){u()}),e("input[name=ticket_provider]:checked").each(function(){u()}),e(document.getElementById("settings_form_toggle")).on("click",function(t){b(t,k)}),e(document.getElementById("tribe_settings_form_cancel")).on("click",function(t){b(t,k)}),e(".ticket_form_toggle").on("click",function(t){b(t,g),"ticket_form_toggle"===e(this).attr("id")?e("#Tribe__Tickets_Plus__Commerce__WooCommerce__Main_radio").prop("checked",!0):e("#Tribe__Tickets__RSVP_radio").prop("checked",!0),r.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("focus.tribe"),e("#ticket_form").show(),e(document.getElementById("tribetickets")).trigger("ticket-provider-changed.tribe")}),e(document.getElementById("ticket_form_cancel")).on("click",function(t){b(t,g),r.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("focus.tribe")}),e("#ticket_form_save").click(function(t){var i=e("#ticket_form_table"),a=i.find(".ticket_provider:checked").val(),n=i.find(".ticket, .ticket_advanced_meta, .ticket_advanced_"+a);r.trigger("save-ticket.tribe",t).trigger("spin.tribe","start");var c={action:"tribe-ticket-add-"+e("input[name=ticket_provider]:checked").val(),formdata:n.find(".ticket_field").serialize(),post_ID:e("#post_ID").val(),nonce:TribeTickets.add_ticket_nonce};e.post(ajaxurl,c,function(t){r.trigger("saved-ticket.tribe",t),t.success&&(r.trigger("clear.tribe"),e("td.ticket_list_container").empty().html(t.data.html),e(".ticket_time").hide())},"json").complete(function(){r.trigger("spin.tribe","stop").trigger("focus.tribe")})}),r.on("click",".ticket_delete",function(t){if(!confirm(tribe_ticket_notices.confirm_alert))return!1;t.preventDefault(),r.trigger("delete-ticket.tribe",t).trigger("spin.tribe","start");var i={action:"tribe-ticket-delete-"+e(this).attr("attr-provider"),post_ID:e("#post_ID").val(),ticket_id:e(this).attr("attr-ticket-id"),nonce:TribeTickets.remove_ticket_nonce};e.post(ajaxurl,i,function(t){r.trigger("deleted-ticket.tribe",t),t.success&&(r.trigger("clear.tribe"),e("td.ticket_list_container").empty().html(t.data))},"json").complete(function(){r.trigger("spin.tribe","stop")})}),r.on("click",".ticket_edit_button",function(t){t.preventDefault(),r.trigger("spin.tribe","start");var i={action:"tribe-ticket-edit-"+this.getAttribute("data-provider"),post_ID:e("#post_ID").val(),ticket_id:this.getAttribute("data-ticket-id"),nonce:TribeTickets.edit_ticket_nonce};e.post(ajaxurl,i,function(t){if(r.trigger("clear.tribe").trigger("set-advanced-fields.tribe").trigger("edit-ticket.tribe",t),!t)return console.log("FAIL"),void console.log(t);var i=t.data.price,a=i,n=!1;"undefined"!=typeof t.data.on_sale&&t.data.on_sale&&(n=!0,i=t.data.regular_price),e("#ticket_id").val(t.data.ID),e("#ticket_name").val(t.data.name),e("#ticket_description").val(t.data.description),n&&e(".ticket_advanced_"+t.data.provider_class+".sale_price").show();var c=t.data.start_date.substring(0,10),d=t.data.end_date.substring(0,10);e("#ticket_start_date").val(c),e("#ticket_end_date").val(d);var o=(e(document.getElementById("ticket_start_meridian")),e(document.getElementById("ticket_end_meridian")));if(t.data.start_date){var s=parseInt(t.data.start_date.substring(11,13)),l="am";s>12&&(l="pm",s=parseInt(s)-12,s=("0"+s).slice(-2)),12===s&&(l="pm"),0===s&&"am"===l&&(s=12),s=s.toString(),1===s.length&&(s="0"+s),e("#ticket_start_hour").val(s).trigger("change"),e("#ticket_start_minute").val(t.data.start_date.substring(14,16)).trigger("change"),e("#ticket_start_meridian").val(l).trigger("change"),e(".ticket_start_time").show()}if(t.data.end_date){var _=parseInt(t.data.end_date.substring(11,13)),g="am";_>12&&o.length&&(g="pm",_=parseInt(_)-12,_=("0"+_).slice(-2)),12===_&&(g="pm"),0===_&&"am"===g&&(_=12),_=_.toString(),1===_.length&&(_="0"+_),e("#ticket_end_hour").val(_).trigger("change"),e("#ticket_end_minute").val(t.data.end_date.substring(14,16)).trigger("change"),e("#ticket_end_meridian").val(g).trigger("change"),e(".ticket_end_time").show()}var k=e("tr.ticket_advanced input");k.data("name",k.attr("name")).attr({name:"",id:""}),e("tr.ticket_advanced").remove(),e("tr.ticket.bottom").before(t.data.advanced_fields),e("input:radio[name=ticket_provider]").filter("[value="+t.data.provider_class+"]").click(),e("input[name=ticket_provider]:radio").change();var m=r.find("#ticket_price");m.val(i),"undefined"!=typeof t.data.disallow_update_price_message?m.siblings(".no-update-message").html(t.data.disallow_update_price_message):m.siblings(".no-update-message").html(""),"undefined"==typeof t.data.can_update_price||t.data.can_update_price?(m.removeProp("disabled"),m.siblings(".description").show(),m.siblings(".no-update-message").hide()):(m.prop("disabled","disabled"),m.siblings(".description").hide(),m.siblings(".no-update-message").show());var p=r.find("#ticket_sale_price");n?p.val(a).closest("tr").show():p.closest("tr").hide(),"undefined"!=typeof t.data.purchase_limit&&t.data.purchase_limit&&e("#ticket_purchase_limit").val(t.data.purchase_limit),r.find(".tribe-bumpdown-trigger").bumpdown(),e("#ticket_form").show(),r.trigger("set-advanced-fields.tribe").trigger("edit-ticket.tribe",t)},"json").complete(function(){r.trigger("spin.tribe","stop").trigger("focus.tribe").trigger("edit-tickets-complete.tribe"),b(t,g)})}).on("keyup","#ticket_price",function(t){t.preventDefault();var i=price_format.decimal,a=new RegExp("[^-0-9%\\"+i+"]+","gi"),r=e(this).val(),n=r.replace(a,"");r!==n&&e(this).val(n)}).on("click","#tribe_ticket_header_image, #tribe_ticket_header_preview",function(t){t.preventDefault(),ticketHeaderImage.uploader("","")}).on("click","#tribe_settings_form_save",function(t){t.preventDefault();var i=e("#tribe_panel_settings"),a={action:"tribe-ticket-save-settings",formdata:i.find(".settings_field").serialize(),post_ID:e("#post_ID").val(),nonce:TribeTickets.add_ticket_nonce};e.post(ajaxurl,a,function(t){r.trigger("saved-image.tribe",t)},"json")});var y=e("#tribe_ticket_header_remove"),w=e("#tribe_ticket_header_preview");if(w.find("img").length&&y.show(),d.change(function(){o=!0}),e('input[type="submit"]').click(function(){o=!1}),e(t).on("beforeunload",function(){if(o)return tribe_global_stock_admin_ui.nav_away_msg}),e("body").on("click","#tribe_ticket_header_remove",function(t){t.preventDefault(),w.html(""),y.hide(),e("#tribe_ticket_header_image_id").val("")}),e("#tribe_ticket_header_preview img").length){var I=e("#tribe_ticket_header_preview img");I.removeAttr("width").removeAttr("height"),r.width()<I.width()&&I.css("width","95%")}})}(window,jQuery);